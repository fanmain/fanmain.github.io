<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content=" 京喜APP最早在2019年引入了Swift，使用Swift完成了第一个订单模块的开发。之后一年多我们持续在团队/公司内部推广和普及Swift，目前Swift已经支撑了70%+以上的业务。通过使用Swift提高了团队内同学的开发效率，同时也带来了质量的提升，目前来自Swift的Crash的占比不到1%。在这过程中不断的学习/实践，团队内的Code Review，也对如何使用Swift来提高代码质量有更深的理解。\n前言 京喜APP最早在2019年引入了Swift，使用Swift完成了第一个订单模块的开发。之后一年多我们持续在团队/公司内部推广和普及Swift，目前Swift已经支撑了70%+以上的业务。通过使用Swift提高了团队内同学的开发效率，同时也带来了质量的提升，目前来自Swift的Crash的占比不到1%。在这过程中不断的学习/实践，团队内的Code Review，也对如何使用Swift来提高代码质量有更深的理解。\nSwift特性 在讨论如何使用Swift提高代码质量之前，我们先来看看Swift本身相比ObjC或其他编程语言有什么优势。Swift有三个重要的特性分别是富有表现力/安全性/快速，接下来我们分别从这三个特性简单介绍一下：\n富有表现力 Swift提供更多的编程范式和特性支持，可以编写更少的代码，而且易于阅读和维护。\n基础类型\u00a0- 元组、Enum关联类型 方法\u00a0-\u00a0方法重载 protocol\u00a0- 不限制只支持class、协议默认实现、类专属协议 泛型\u00a0-\u00a0protocol关联类型、where实现类型约束、泛型扩展 可选值\u00a0- 可选值申明、可选链、隐式可选值 属性\u00a0- let、lazy、计算属性`、willset/didset、Property Wrappers 函数式编程\u00a0- 集合filter/map/reduce方法，提供更多标准库方法 并发\u00a0- async/await、actor 标准库框架\u00a0-\u00a0Combine响应式框架、SwiftUI申明式UI框架、CodableJSON模型转换 Result builder\u00a0- 描述实现DSL的能力 动态性\u00a0- dynamicCallable、dynamicMemberLookup 其他\u00a0- 扩展、subscript、操作符重写、嵌套类型、区间 Swift Package Manager\u00a0- 基于Swift的包管理工具，可以直接用Xcode进行管理更方便 struct\u00a0- 初始化方法自动补齐 类型推断\u00a0- 通过编译器强大的类型推断编写代码时可以减少很多类型申明 提示：类型推断同时也会增加一定的编译耗时，不过Swift团队也在不断的改善编译速度。\n安全性 代码安全 let属性\u00a0- 使用let申明常量避免被修改。 值类型\u00a0- 值类型可以避免在方法调用等参数传递过程中状态被修改。 访问控制\u00a0- 通过public和final限制模块外使用class不能被继承和重写。 强制异常处理\u00a0- 方法需要抛出异常时，需要申明为throw方法。当调用可能会throw异常的方法，需要强制捕获异常避免将异常暴露到上层。 模式匹配\u00a0- 通过模式匹配检测switch中未处理的case。 类型安全 强制类型转换\u00a0- 禁止隐式类型转换避免转换中带来的异常问题。同时类型转换不会带来额外的运行时消耗。。 提示：编写ObjC代码时，我们通常会在编码时添加类型检查避免运行时崩溃导致Crash。\n">
<title>04_swiftTip</title>

<link rel='canonical' href='http://localhost:1313/post/ios/2024/04_swifttip/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="04_swiftTip">
<meta property='og:description' content=" 京喜APP最早在2019年引入了Swift，使用Swift完成了第一个订单模块的开发。之后一年多我们持续在团队/公司内部推广和普及Swift，目前Swift已经支撑了70%+以上的业务。通过使用Swift提高了团队内同学的开发效率，同时也带来了质量的提升，目前来自Swift的Crash的占比不到1%。在这过程中不断的学习/实践，团队内的Code Review，也对如何使用Swift来提高代码质量有更深的理解。\n前言 京喜APP最早在2019年引入了Swift，使用Swift完成了第一个订单模块的开发。之后一年多我们持续在团队/公司内部推广和普及Swift，目前Swift已经支撑了70%+以上的业务。通过使用Swift提高了团队内同学的开发效率，同时也带来了质量的提升，目前来自Swift的Crash的占比不到1%。在这过程中不断的学习/实践，团队内的Code Review，也对如何使用Swift来提高代码质量有更深的理解。\nSwift特性 在讨论如何使用Swift提高代码质量之前，我们先来看看Swift本身相比ObjC或其他编程语言有什么优势。Swift有三个重要的特性分别是富有表现力/安全性/快速，接下来我们分别从这三个特性简单介绍一下：\n富有表现力 Swift提供更多的编程范式和特性支持，可以编写更少的代码，而且易于阅读和维护。\n基础类型\u00a0- 元组、Enum关联类型 方法\u00a0-\u00a0方法重载 protocol\u00a0- 不限制只支持class、协议默认实现、类专属协议 泛型\u00a0-\u00a0protocol关联类型、where实现类型约束、泛型扩展 可选值\u00a0- 可选值申明、可选链、隐式可选值 属性\u00a0- let、lazy、计算属性`、willset/didset、Property Wrappers 函数式编程\u00a0- 集合filter/map/reduce方法，提供更多标准库方法 并发\u00a0- async/await、actor 标准库框架\u00a0-\u00a0Combine响应式框架、SwiftUI申明式UI框架、CodableJSON模型转换 Result builder\u00a0- 描述实现DSL的能力 动态性\u00a0- dynamicCallable、dynamicMemberLookup 其他\u00a0- 扩展、subscript、操作符重写、嵌套类型、区间 Swift Package Manager\u00a0- 基于Swift的包管理工具，可以直接用Xcode进行管理更方便 struct\u00a0- 初始化方法自动补齐 类型推断\u00a0- 通过编译器强大的类型推断编写代码时可以减少很多类型申明 提示：类型推断同时也会增加一定的编译耗时，不过Swift团队也在不断的改善编译速度。\n安全性 代码安全 let属性\u00a0- 使用let申明常量避免被修改。 值类型\u00a0- 值类型可以避免在方法调用等参数传递过程中状态被修改。 访问控制\u00a0- 通过public和final限制模块外使用class不能被继承和重写。 强制异常处理\u00a0- 方法需要抛出异常时，需要申明为throw方法。当调用可能会throw异常的方法，需要强制捕获异常避免将异常暴露到上层。 模式匹配\u00a0- 通过模式匹配检测switch中未处理的case。 类型安全 强制类型转换\u00a0- 禁止隐式类型转换避免转换中带来的异常问题。同时类型转换不会带来额外的运行时消耗。。 提示：编写ObjC代码时，我们通常会在编码时添加类型检查避免运行时崩溃导致Crash。\n">
<meta property='og:url' content='http://localhost:1313/post/ios/2024/04_swifttip/'>
<meta property='og:site_name' content='fan&#39;s blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-05-16T14:29:25&#43;08:00'/><meta property='article:modified_time' content='2024-05-16T14:29:25&#43;08:00'/>
<meta name="twitter:title" content="04_swiftTip">
<meta name="twitter:description" content=" 京喜APP最早在2019年引入了Swift，使用Swift完成了第一个订单模块的开发。之后一年多我们持续在团队/公司内部推广和普及Swift，目前Swift已经支撑了70%+以上的业务。通过使用Swift提高了团队内同学的开发效率，同时也带来了质量的提升，目前来自Swift的Crash的占比不到1%。在这过程中不断的学习/实践，团队内的Code Review，也对如何使用Swift来提高代码质量有更深的理解。\n前言 京喜APP最早在2019年引入了Swift，使用Swift完成了第一个订单模块的开发。之后一年多我们持续在团队/公司内部推广和普及Swift，目前Swift已经支撑了70%+以上的业务。通过使用Swift提高了团队内同学的开发效率，同时也带来了质量的提升，目前来自Swift的Crash的占比不到1%。在这过程中不断的学习/实践，团队内的Code Review，也对如何使用Swift来提高代码质量有更深的理解。\nSwift特性 在讨论如何使用Swift提高代码质量之前，我们先来看看Swift本身相比ObjC或其他编程语言有什么优势。Swift有三个重要的特性分别是富有表现力/安全性/快速，接下来我们分别从这三个特性简单介绍一下：\n富有表现力 Swift提供更多的编程范式和特性支持，可以编写更少的代码，而且易于阅读和维护。\n基础类型\u00a0- 元组、Enum关联类型 方法\u00a0-\u00a0方法重载 protocol\u00a0- 不限制只支持class、协议默认实现、类专属协议 泛型\u00a0-\u00a0protocol关联类型、where实现类型约束、泛型扩展 可选值\u00a0- 可选值申明、可选链、隐式可选值 属性\u00a0- let、lazy、计算属性`、willset/didset、Property Wrappers 函数式编程\u00a0- 集合filter/map/reduce方法，提供更多标准库方法 并发\u00a0- async/await、actor 标准库框架\u00a0-\u00a0Combine响应式框架、SwiftUI申明式UI框架、CodableJSON模型转换 Result builder\u00a0- 描述实现DSL的能力 动态性\u00a0- dynamicCallable、dynamicMemberLookup 其他\u00a0- 扩展、subscript、操作符重写、嵌套类型、区间 Swift Package Manager\u00a0- 基于Swift的包管理工具，可以直接用Xcode进行管理更方便 struct\u00a0- 初始化方法自动补齐 类型推断\u00a0- 通过编译器强大的类型推断编写代码时可以减少很多类型申明 提示：类型推断同时也会增加一定的编译耗时，不过Swift团队也在不断的改善编译速度。\n安全性 代码安全 let属性\u00a0- 使用let申明常量避免被修改。 值类型\u00a0- 值类型可以避免在方法调用等参数传递过程中状态被修改。 访问控制\u00a0- 通过public和final限制模块外使用class不能被继承和重写。 强制异常处理\u00a0- 方法需要抛出异常时，需要申明为throw方法。当调用可能会throw异常的方法，需要强制捕获异常避免将异常暴露到上层。 模式匹配\u00a0- 通过模式匹配检测switch中未处理的case。 类型安全 强制类型转换\u00a0- 禁止隐式类型转换避免转换中带来的异常问题。同时类型转换不会带来额外的运行时消耗。。 提示：编写ObjC代码时，我们通常会在编码时添加类型检查避免运行时崩溃导致Crash。\n">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_6c1f32e22984c769.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">fan&#39;s blog</a></h1>
            <h2 class="site-description">不积跬步，无以至千里</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#富有表现力">富有表现力</a></li>
        <li><a href="#安全性">安全性</a>
          <ol>
            <li><a href="#代码安全">代码安全</a></li>
            <li><a href="#类型安全">类型安全</a></li>
            <li><a href="#内存安全">内存安全</a></li>
            <li><a href="#线程安全">线程安全</a></li>
          </ol>
        </li>
        <li><a href="#快速">快速</a></li>
      </ol>
    </li>
  </ol>

  <ol>
    <li><a href="#一些不错的实践">一些不错的实践</a>
      <ol>
        <li><a href="#利用编译检查">利用编译检查</a>
          <ol>
            <li><a href="#减少使用anyanyobject">减少使用<code>Any/AnyObject</code></a></li>
            <li><a href="#使用自定义类型代替dictionary">使用<code>自定义类型</code>代替<code>Dictionary</code></a></li>
            <li><a href="#使用枚举关联值代替any">使用<code>枚举关联值</code>代替<code>Any</code></a></li>
            <li><a href="#使用泛型协议关联类型代替any">使用<code>泛型</code>/<code>协议关联类型</code>代替<code>Any</code></a></li>
            <li><a href="#使用枚举常量代替硬编码">使用<code>枚举</code>/<code>常量</code>代替<code>硬编码</code></a></li>
            <li><a href="#使用keypath代替字符串硬编码">使用<code>KeyPath</code>代替<code>字符串</code>硬编码</a></li>
          </ol>
        </li>
        <li><a href="#内存安全-1">内存安全</a>
          <ol>
            <li><a href="#减少使用属性">减少使用<code>!</code>属性</a></li>
            <li><a href="#减少使用进行强解包">减少使用<code>!</code>进行强解包</a></li>
            <li><a href="#避免使用try进行错误处理">避免使用<code>try!</code>进行错误处理</a></li>
            <li><a href="#使用weakunowned避免循环引用">使用<code>weak</code>/<code>unowned</code>避免循环引用</a></li>
            <li><a href="#减少使用unowned">减少使用<code>unowned</code></a></li>
          </ol>
        </li>
        <li><a href="#错误处理方式">错误处理方式</a></li>
        <li><a href="#减少使用可选值">减少使用可选值</a>
          <ol>
            <li><a href="#使用init注入代替可选值属性">使用<code>init</code>注入代替<code>可选值</code>属性</a></li>
            <li><a href="#避免随意给予可选值默认值">避免随意给予可选值默认值</a></li>
            <li><a href="#使用枚举优化可选值">使用枚举优化可选值</a></li>
          </ol>
        </li>
        <li><a href="#减少var属性">减少<code>var</code>属性</a>
          <ol>
            <li><a href="#使用计算属性">使用计算属性</a></li>
          </ol>
        </li>
        <li><a href="#控制流">控制流</a>
          <ol>
            <li><a href="#使用filterreducemap代替for循环">使用<code>filter/reduce/map</code>代替<code>for</code>循环</a></li>
            <li><a href="#使用guard进行提前返回">使用<code>guard</code>进行提前返回</a></li>
            <li><a href="#使用三元运算符">使用三元运算符<code>?:</code></a></li>
            <li><a href="#使用for-where优化循环">使用<code>for where</code>优化循环</a></li>
            <li><a href="#使用defer">使用<code>defer</code></a></li>
          </ol>
        </li>
        <li><a href="#字符串">字符串</a>
          <ol>
            <li><a href="#使用">使用<code>&quot;&quot;&quot;</code></a></li>
            <li><a href="#使用字符串插值">使用字符串插值</a></li>
          </ol>
        </li>
        <li><a href="#集合">集合</a>
          <ol>
            <li><a href="#使用标准库提供的高阶函数">使用标准库提供的高阶函数</a></li>
          </ol>
        </li>
        <li><a href="#访问控制">访问控制</a>
          <ol>
            <li><a href="#使用privatefileprivate修饰私有属性和方法">使用<code>private</code>/<code>fileprivate</code>修饰私有<code>属性</code>和<code>方法</code></a></li>
            <li><a href="#使用privateset修饰外部只读内部可读写属性">使用<code>private(set)</code>修饰外部只读/内部可读写属性</a></li>
          </ol>
        </li>
        <li><a href="#函数">函数</a>
          <ol>
            <li><a href="#使用参数默认值">使用参数默认值</a></li>
            <li><a href="#限制参数数量">限制参数数量</a></li>
            <li><a href="#使用discardableresult">使用<code>@discardableResult</code></a></li>
          </ol>
        </li>
        <li><a href="#元组">元组</a>
          <ol>
            <li><a href="#避免过长的元组">避免过长的元组</a></li>
          </ol>
        </li>
        <li><a href="#系统库">系统库</a>
          <ol>
            <li><a href="#kvonotification使用blockapi"><code>KVO</code>/<code>Notification</code> 使用 <code>block</code> API</a></li>
          </ol>
        </li>
        <li><a href="#protocol">Protocol</a>
          <ol>
            <li><a href="#使用protocol代替继承">使用<code>protocol</code>代替继承</a></li>
          </ol>
        </li>
        <li><a href="#extension">Extension</a>
          <ol>
            <li><a href="#使用extension组织代码">使用<code>extension</code>组织代码</a></li>
          </ol>
        </li>
        <li><a href="#代码风格">代码风格</a></li>
      </ol>
    </li>
    <li><a href="#性能优化">性能优化</a>
      <ol>
        <li><a href="#使用whole-module-optimization">使用<code>Whole Module Optimization</code></a></li>
        <li><a href="#使用源代码打包">使用<code>源代码</code>打包</a></li>
        <li><a href="#减少方法动态派发">减少方法<code>动态</code>派发</a></li>
        <li><a href="#使用slice共享内存优化性能">使用<code>Slice</code>共享内存优化性能</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/ios/2024/04_swifttip/">04_swiftTip</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 16, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 10 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>

















<img 
    src="https://img2023.cnblogs.com/blog/2927063/202305/2927063-20230510105716314-83577057.png" 
    alt="万字长文详解如何使用Swift提高代码质量" 
     
/> 京喜APP最早在2019年引入了Swift，使用Swift完成了第一个订单模块的开发。之后一年多我们持续在团队/公司内部推广和普及Swift，目前Swift已经支撑了70%+以上的业务。通过使用Swift提高了团队内同学的开发效率，同时也带来了质量的提升，目前来自Swift的Crash的占比不到1%。在这过程中不断的学习/实践，团队内的Code Review，也对如何使用Swift来提高代码质量有更深的理解。</p>
<h1 id="前言">前言
</h1><p><code>京喜APP</code>最早在2019年引入了<code>Swift</code>，使用<code>Swift</code>完成了第一个订单模块的开发。之后一年多我们持续在团队/公司内部推广和普及<code>Swift</code>，目前<code>Swift</code>已经支撑了<code>70%+</code>以上的业务。通过使用<code>Swift</code>提高了团队内同学的开发效率，同时也带来了质量的提升，目前来自<code>Swift</code>的Crash的占比不到<code>1%</code>。在这过程中不断的学习/实践，团队内的<code>Code Review</code>，也对如何使用<code>Swift</code>来提高代码质量有更深的理解。</p>
<h1 id="swift特性">Swift特性
</h1><p>在讨论如何使用<code>Swift</code>提高代码质量之前，我们先来看看<code>Swift</code>本身相比<code>ObjC</code>或其他编程语言有什么优势。<code>Swift</code>有三个重要的特性分别是<code>富有表现力</code>/<code>安全性</code>/<code>快速</code>，接下来我们分别从这三个特性简单介绍一下：</p>
<h3 id="富有表现力">富有表现力
</h3><p><code>Swift</code>提供更多的<code>编程范式</code>和<code>特性</code>支持，可以编写更少的代码，而且易于阅读和维护。</p>
<ul>
<li><code>基础类型</code> - 元组、Enum<code>关联类型</code></li>
<li><code>方法</code> - <code>方法重载</code></li>
<li><code>protocol</code> - 不限制只支持<code>class</code>、协议<code>默认</code>实现、<code>类</code>专属协议</li>
<li><code>泛型</code> - <code>protocol</code>关联类型、<code>where</code>实现类型约束、泛型扩展</li>
<li><code>可选值</code> - 可选值申明、可选链、隐式可选值</li>
<li><code>属性</code> - let、lazy、计算属性`、willset/didset、Property Wrappers</li>
<li><code>函数式编程</code> - 集合<code>filter/map/reduce</code>方法，提供更多标准库方法</li>
<li><code>并发</code> - async/await、actor</li>
<li><code>标准库框架</code> - <code>Combine</code>响应式框架、<code>SwiftUI</code>申明式UI框架、<code>Codable</code>JSON模型转换</li>
<li><code>Result builder</code> - 描述实现<code>DSL</code>的能力</li>
<li><code>动态性</code> - dynamicCallable、dynamicMemberLookup</li>
<li><code>其他</code> - 扩展、subscript、操作符重写、嵌套类型、区间</li>
<li><code>Swift Package Manager</code> - 基于Swift的包管理工具，可以直接用<code>Xcode</code>进行管理更方便</li>
<li><code>struct</code> - 初始化方法自动补齐</li>
<li><code>类型推断</code> - 通过编译器强大的<code>类型推断</code>编写代码时可以减少很多类型申明</li>
</ul>
<blockquote>
<p>提示：类型推断同时也会增加一定的编译<code>耗时</code>，不过<code>Swift</code>团队也在不断的改善编译速度。</p></blockquote>
<h3 id="安全性">安全性
</h3><h4 id="代码安全">代码安全
</h4><ul>
<li><code>let属性</code> - 使用<code>let</code>申明常量避免被修改。</li>
<li><code>值类型</code> - 值类型可以避免在方法调用等<code>参数传递</code>过程中状态被修改。</li>
<li><code>访问控制</code> - 通过<code>public</code>和<code>final</code>限制模块外使用<code>class</code>不能被<code>继承</code>和<code>重写</code>。</li>
<li><code>强制异常处理</code> - 方法需要抛出异常时，需要申明为<code>throw</code>方法。当调用可能会<code>throw</code>异常的方法，需要强制捕获异常避免将异常暴露到上层。</li>
<li><code>模式匹配</code> - 通过模式匹配检测<code>switch</code>中未处理的case。</li>
</ul>
<h4 id="类型安全">类型安全
</h4><ul>
<li><code>强制类型转换</code> - 禁止<code>隐式类型转换</code>避免转换中带来的异常问题。同时类型转换不会带来<code>额外</code>的运行时消耗。。</li>
</ul>
<blockquote>
<p>提示：编写<code>ObjC</code>代码时，我们通常会在编码时添加类型检查避免运行时崩溃导致<code>Crash</code>。</p></blockquote>
<ul>
<li><code>KeyPath</code> - <code>KeyPath</code>相比使用<code>字符串</code>可以提供属性名和类型信息，可以利用编译器检查。</li>
<li><code>泛型</code> - 提供<code>泛型</code>和协议<code>关联类型</code>，可以编写出类型安全的代码。相比<code>Any</code>可以更多利用编译时检查发现类型问题。</li>
<li><code>Enum关联类型</code> - 通过给特定枚举指定类型避免使用<code>Any</code>。</li>
</ul>
<h4 id="内存安全">内存安全
</h4><ul>
<li><code>空安全</code> - 通过标识可选值避免<code>空指针</code>带来的异常问题</li>
<li><code>ARC</code> - 使用<code>自动</code>内存管理避免<code>手动</code>管理内存带来的各种内存问题</li>
<li><code>强制初始化</code> - 变量使用前必须<code>初始化</code></li>
<li><code>内存独占访问</code> - 通过编译器检查发现潜在的内存冲突问题</li>
</ul>
<h4 id="线程安全">线程安全
</h4><ul>
<li><code>值类型</code> - 更多使用值类型减少在多线程中遇到的<code>数据竞争</code>问题</li>
<li><code>async/await</code> - 提供<code>async</code>函数使我们可以用结构化的方式编写并发操作。避免基于<code>闭包</code>的异步方式带来的内存<code>循环引用</code>和无法抛出异常的问题</li>
<li><code>Actor</code> - 提供<code>Actor</code>模型避免多线程开发中进行数据共享时发生的数据竞争问题，同时避免在使用锁时带来的死锁等问题</li>
</ul>
<h3 id="快速">快速
</h3><ul>
<li><code>值类型</code> - 相比<code>class</code>不需要额外的<code>堆内存</code>分配/释放和更少的内存消耗</li>
<li><code>方法静态派发</code> - 方法调用支持<code>静态</code>调用相比原有ObjC<code>消息转发</code>调用性能更好</li>
<li><code>编译器优化</code> - Swift的<code>静态性</code>可以使编译器做更多优化。例如<code>Tree Shaking</code>相关优化移除未使用的类型/方法等减少二进制文件大小。使用<code>静态派发</code>/<code>方法内联优化</code>/<code>泛型特化</code>/<code>写时复制</code>等优化提高运行时性能</li>
</ul>
<blockquote>
<p>提示：<code>ObjC</code>消息派发会导致编译器无法进行移除无用方法/类的优化，编译器并不知道是否可能被用到。</p></blockquote>
<ul>
<li><code>ARC优化</code> - 虽然和<code>ObjC</code>一样都是使用<code>ARC</code>，<code>Swift</code>通过编译器优化，可以进行更快的内存回收和更少的内存引用计数管理</li>
</ul>
<blockquote>
<p>提示： 相比<code>ObjC</code>，Swift内部不需要使用<code>autorelease</code>进行管理。</p></blockquote>
<h1 id="代码质量指标">代码质量指标
</h1><p>

















<img 
    src="https://oscimg.oschina.net/oscnet/up-6f28bb4fcff4d48520c4d0f1ff4f9fc57f2.png" 
    alt="" 
     
/></p>
<p>以上是一些常见的代码质量指标。我们的目标是如何更好的使用<code>Swift</code>编写出符合代码质量指标要求的代码。</p>
<blockquote>
<p>提示：本文不涉及设计模式/架构，更多关注如何通过合理使用<code>Swift</code>特性做局部代码段的重构。</p></blockquote>
<h2 id="一些不错的实践">一些不错的实践
</h2><h3 id="利用编译检查">利用编译检查
</h3><h4 id="减少使用anyanyobject">减少使用<code>Any/AnyObject</code>
</h4><p>因为<code>Any/AnyObject</code>缺少明确的类型信息，编译器无法进行类型检查，会带来一些问题：</p>
<ul>
<li>编译器无法检查类型是否正确保证类型安全</li>
<li>代码中大量的<code>as?</code>转换</li>
<li>类型的缺失导致编译器无法做一些潜在的<code>编译优化</code></li>
</ul>
<p>使用<code>as?</code>带来的问题</p>
<p>当使用<code>Any/AnyObject</code>时会频繁使用<code>as?</code>进行类型转换。这好像没什么问题因为使用<code>as?</code>并不会导致程序<code>Crash</code>。不过代码错误至少应该分为两类，一类是程序本身的错误通常会引发Crash，另外一种是业务逻辑错误。使用<code>as?</code>只是避免了程序错误<code>Crash</code>，但是并不能防止业务逻辑错误。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">do</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">Any</span><span class="p">?)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">string</span> <span class="p">=</span> <span class="n">data</span> <span class="k">as</span><span class="p">?</span> <span class="nb">String</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// </span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">do</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上面的例子为例，我们进行了<code>as?</code>转换，当<code>data</code>为<code>String</code>时才会进行处理。但是当<code>do</code>方法内<code>String</code>类型发生了改变函数，使用方并不知道已变更没有做相应的适配，这时候就会造成业务逻辑的错误。</p>
<blockquote>
<p>提示：这类错误通常更难发现，这也是我们在一次真实<code>bug</code>场景遇到的。</p></blockquote>
<h4 id="使用自定义类型代替dictionary">使用<code>自定义类型</code>代替<code>Dictionary</code>
</h4><p>代码中大量<code>Dictionary</code>数据结构会降低代码可维护性，同时带来潜在的<code>bug</code>：</p>
<ul>
<li><code>key</code>需要字符串硬编码，编译时无法检查</li>
<li><code>value</code>没有类型限制。<code>修改</code>时类型无法限制，读取时需要重复类型转换和解包操作</li>
<li>无法利用<code>空安全</code>特性，指定某个属性必须有值</li>
</ul>
<blockquote>
<p>提示：<code>自定义类型</code>还有个好处，例如<code>JSON</code>转<code>自定义类型</code>时会进行<code>类型/nil/属性名</code>检查，可以避免将错误数据丢到下一层。</p></blockquote>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">dic</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="o">:</span> <span class="nx">Any</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">num</span> <span class="o">=</span> <span class="nx">dic</span><span class="p">[</span><span class="s2">&#34;value&#34;</span><span class="p">]</span> <span class="nx">as</span><span class="o">?</span> <span class="nx">Int</span>
</span></span><span class="line"><span class="cl"><span class="nx">dic</span><span class="p">[</span><span class="s2">&#34;name&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;name&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">struct</span> <span class="n">Data</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">let</span> <span class="kt">num</span><span class="o">:</span> <span class="n">Int</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nl">name:</span> <span class="kt">String</span><span class="o">?</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">let</span> <span class="kt">num</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="kt">num</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;name&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>适合使用<code>Dictionary</code>的场景</p>
<ul>
<li><code>数据不使用</code> - 数据并不<code>读取</code>只是用来传递。</li>
<li><code>解耦</code> - 1.<code>组件间通信</code>解耦使用<code>HashMap</code>传递参数进行通信。2.跨技术栈边界的场景，<code>混合栈间通信/前后端通信</code>使用<code>HashMap</code>/<code>JSON</code>进行通信。</li>
</ul>
<h4 id="使用枚举关联值代替any">使用<code>枚举关联值</code>代替<code>Any</code>
</h4><p>例如使用枚举改造<code>NSAttributedString</code>API，原有API<code>value</code>为<code>Any</code>类型无法限制特定的类型。</p>
<p>优化前</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">let</span> <span class="kt">string</span> <span class="p">=</span> <span class="nf">NSMutableAttributedString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kt">string</span><span class="p">.</span><span class="nf">addAttribute</span><span class="p">(.</span><span class="nx">foregroundColor</span><span class="p">,</span> <span class="nx">value</span><span class="p">:</span> <span class="nx">UIColor</span><span class="p">.</span><span class="nx">red</span><span class="p">,</span> <span class="k">range</span><span class="p">:</span> <span class="k">range</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>改造后</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">enum</span> <span class="n">NSAttributedStringKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="n">foregroundColor</span><span class="p">(</span><span class="n">UIColor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="kt">string</span> <span class="p">=</span> <span class="n">NSMutableAttributedString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kt">string</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(.</span><span class="n">foregroundColor</span><span class="p">(</span><span class="n">UIColor</span><span class="p">.</span><span class="n">red</span><span class="p">),</span> <span class="n">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span> <span class="c1">// 不传递Color会报错</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用泛型协议关联类型代替any">使用<code>泛型</code>/<code>协议关联类型</code>代替<code>Any</code>
</h4><p>使用<code>泛型</code>或<code>协议关联类型</code>代替<code>Any</code>，通过<code>泛型类型约束</code>来使编译器进行更多的类型检查。</p>
<h4 id="使用枚举常量代替硬编码">使用<code>枚举</code>/<code>常量</code>代替<code>硬编码</code>
</h4><p>代码中存在重复的<code>硬编码</code>字符串/数字，在修改时可能会因为不同步引发<code>bug</code>。尽可能减少<code>硬编码</code>字符串/数字，使用<code>枚举</code>或<code>常量</code>代替。</p>
<h4 id="使用keypath代替字符串硬编码">使用<code>KeyPath</code>代替<code>字符串</code>硬编码
</h4><p><code>KeyPath</code>包含属性名和类型信息，可以避免<code>硬编码</code>字符串，同时当属性名或类型改变时编译器会进行检查。</p>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">SomeClass</span><span class="p">:</span> <span class="n">NSObject</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">@objc</span> <span class="kr">dynamic</span> <span class="kd">var</span> <span class="nv">someProperty</span><span class="p">:</span> <span class="nb">Int</span>
</span></span><span class="line"><span class="cl">    <span class="kd">init</span><span class="p">(</span><span class="n">someProperty</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kc">self</span><span class="p">.</span><span class="n">someProperty</span> <span class="p">=</span> <span class="n">someProperty</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">object</span> <span class="p">=</span> <span class="n">SomeClass</span><span class="p">(</span><span class="n">someProperty</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">object</span><span class="p">.</span><span class="n">observeValue</span><span class="p">(</span><span class="n">forKeyPath</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">of</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">change</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">let</span> <span class="kt">object</span> <span class="o">=</span> <span class="nx">SomeClass</span><span class="p">(</span><span class="nx">someProperty</span>: <span class="kt">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">object</span><span class="p">.</span><span class="nx">observe</span><span class="p">(.</span><span class="nx">someProperty</span><span class="p">)</span> <span class="p">{</span> <span class="kt">object</span><span class="p">,</span> <span class="nx">change</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="内存安全-1">内存安全
</h3><h4 id="减少使用属性">减少使用<code>!</code>属性
</h4><p><code>!</code>属性会在读取时隐式<code>强解包</code>，当值不存在时产生运行时异常导致Crash。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@IBOutlet</span> <span class="k">private</span> <span class="k">var</span> <span class="py">label</span><span class="p">:</span> <span class="n">UILabel</span><span class="p">!</span> <span class="c1">// @IBOutlet需要使用!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="减少使用进行强解包">减少使用<code>!</code>进行强解包
</h4><p>使用<code>!</code>强解包会在值不存在时产生运行时异常导致Crash。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">var</span> <span class="kt">num</span><span class="o">:</span> <span class="n">Int</span><span class="o">?</span>
</span></span><span class="line"><span class="cl"><span class="n">let</span> <span class="n">num2</span> <span class="o">=</span> <span class="kt">num</span><span class="o">!</span> <span class="c1">// 错误
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>提示：建议只在小范围的局部代码段使用<code>!</code>强解包。</p></blockquote>
<h4 id="避免使用try进行错误处理">避免使用<code>try!</code>进行错误处理
</h4><p>使用<code>try!</code>会在方法抛出异常时产生运行时异常导致Crash。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scss" data-lang="scss"><span class="line"><span class="cl"><span class="nt">try</span><span class="o">!</span> <span class="nt">method</span><span class="o">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用weakunowned避免循环引用">使用<code>weak</code>/<code>unowned</code>避免循环引用
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="n">resource</span><span class="p">.</span><span class="n">request</span><span class="p">().</span><span class="n">onComplete</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="n">response</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">  <span class="k">guard</span> <span class="kd">let</span> <span class="nv">self</span> <span class="p">=</span> <span class="kc">self</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nv">model</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">updateModel</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kc">self</span><span class="p">.</span><span class="n">updateUI</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">resource</span><span class="p">.</span><span class="n">request</span><span class="p">().</span><span class="n">onComplete</span> <span class="p">{</span> <span class="p">[</span><span class="kr">unowned</span> <span class="kc">self</span><span class="p">]</span> <span class="n">response</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nv">model</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">updateModel</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kc">self</span><span class="p">.</span><span class="n">updateUI</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="减少使用unowned">减少使用<code>unowned</code>
</h4><p><code>unowned</code>在值不存在时会产生运行时异常导致Crash，只有在确定<code>self</code>一定会存在时才使用<code>unowned</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">class</span> <span class="n">Class</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">@</span><span class="n">objc</span> <span class="n">unowned</span> <span class="k">var</span> <span class="n">object</span><span class="p">:</span> <span class="ne">Object</span>
</span></span><span class="line"><span class="cl">    <span class="err">@</span><span class="n">objc</span> <span class="n">weak</span> <span class="k">var</span> <span class="n">object</span><span class="p">:</span> <span class="ne">Object</span><span class="err">?</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>unowned</code>/<code>weak</code>区别：</p>
<ul>
<li><code>weak</code> - 必须设置为可选值，会进行弱引用处理性能更差。会自动设置为<code>nil</code></li>
<li><code>unowned</code> - 可以不设置为可选值，不会进行弱引用处理性能更好。但是不会自动设置为<code>nil</code>, 如果<code>self</code>已释放会触发错误.</li>
</ul>
<h3 id="错误处理方式">错误处理方式
</h3><ul>
<li><code>可选值</code> - 调用方并不关注内部可能会发生错误，当发生错误时返回<code>nil</code></li>
<li><code>try/catch</code> - 明确提示调用方需要处理异常，需要实现<code>Error</code>协议定义明确的错误类型</li>
<li><code>assert</code> - 断言。只能在<code>Debug</code>模式下生效</li>
<li><code>precondition</code> - 和<code>assert</code>类似，可以再<code>Debug</code>/<code>Release</code>模式下生效</li>
<li><code>fatalError</code> - 产生运行时崩溃会导致Crash，应避免使用</li>
<li><code>Result</code> - 通常用于<code>闭包</code>异步回调返回值</li>
</ul>
<h3 id="减少使用可选值">减少使用可选值
</h3><p><code>可选值</code>的价值在于通过明确标识值可能会为<code>nil</code>并且编译器强制对值进行<code>nil</code>判断。但是不应该随意的定义可选值，可选值不能用<code>let</code>定义，并且使用时必须进行<code>解包</code>操作相对比较繁琐。在代码设计时应考虑<code>这个值是否有可能为nil</code>，只在合适的场景使用可选值。</p>
<h4 id="使用init注入代替可选值属性">使用<code>init</code>注入代替<code>可选值</code>属性
</h4><p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nb">Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">num</span>: <span class="kt">Int?</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="kt">object</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kt">object</span><span class="p">.</span><span class="nx">num</span> <span class="o">=</span> <span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nv">num</span><span class="p">:</span> <span class="nb">Int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">init</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kc">self</span><span class="p">.</span><span class="n">num</span> <span class="p">=</span> <span class="n">num</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">object</span> <span class="p">=</span> <span class="n">Object</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="避免随意给予可选值默认值">避免随意给予可选值默认值
</h4><p>在使用可选值时，通常我们需要在可选值为<code>nil</code>时进行异常处理。有时候我们会通过给予可选值<code>默认值</code>的方式来处理。但是这里应考虑在什么场景下可以给予默认值。在不能给予默认值的场景应当及时使用<code>return</code>或<code>抛出异常</code>，避免错误的值被传递到更多的业务流程。</p>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">func</span> <span class="nx">confirmOrder</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 给予错误的值会导致错误的值被传递到更多的业务流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">confirmOrder</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span> <span class="nx">orderId</span> <span class="o">??</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">confirmOrder</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">guard</span> <span class="kd">let</span> <span class="nv">orderId</span> <span class="p">=</span> <span class="n">orderId</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 异常处理</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">confirmOrder</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">orderId</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>提示：通常强业务相关的值不能给予默认值：例如<code>商品/订单id</code>或是<code>价格</code>。在可以使用兜底逻辑的场景使用默认值，例如<code>默认文字/文字颜色</code>。</p></blockquote>
<h4 id="使用枚举优化可选值">使用枚举优化可选值
</h4><p><code>Object</code>结构同时只会有一个值存在：</p>
<p>优化前</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="py">name</span><span class="p">:</span> <span class="n">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="py">num</span><span class="p">:</span> <span class="n">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后</p>
<ul>
<li><code>降低内存占用</code> - <code>枚举关联类型</code>的大小取决于最大的关联类型大小</li>
<li><code>逻辑更清晰</code> - 使用<code>enum</code>相比大量使用<code>if/else</code>逻辑更清晰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">enum</span><span class="w"> </span><span class="n">CustomType</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">name</span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">num</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="减少var属性">减少<code>var</code>属性
</h3><h4 id="使用计算属性">使用计算属性
</h4><p>使用<code>计算属性</code>可以减少多个变量同步带来的潜在bug。</p>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">model</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">data</span><span class="o">:</span> <span class="nb">Object</span><span class="o">?</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">loaded</span><span class="o">:</span> <span class="nx">Bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">model</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">model</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="py">data</span><span class="p">:</span> <span class="n">Object</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="py">loaded</span><span class="p">:</span> <span class="n">Bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">data</span> <span class="o">!=</span> <span class="n">nil</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span><span class="p">.</span><span class="k">data</span> <span class="p">=</span> <span class="n">Object</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>提示：计算属性因为每次都会重复计算，所以计算过程需要轻量避免带来性能问题。</p></blockquote>
<h3 id="控制流">控制流
</h3><h4 id="使用filterreducemap代替for循环">使用<code>filter/reduce/map</code>代替<code>for</code>循环
</h4><p>使用<code>filter/reduce/map</code>可以带来很多好处，包括更少的局部变量，减少模板代码，代码更加清晰，可读性更高。</p>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">let</span> <span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="kt">num</span> <span class="k">in</span> <span class="n">nums</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="kt">num</span> <span class="o">&lt;</span> <span class="m">3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="kt">String</span><span class="p">(</span><span class="kt">num</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// result = [&#34;1&#34;, &#34;2&#34;]
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">let</span> <span class="nv">nums</span> <span class="o">=</span> <span class="o">[</span>1, 2, 3<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">let</span> <span class="nv">result</span> <span class="o">=</span> nums.filter <span class="o">{</span> <span class="nv">$0</span> &lt; <span class="m">3</span> <span class="o">}</span>.map <span class="o">{</span> String<span class="o">(</span><span class="nv">$0</span><span class="o">)</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">// <span class="nv">result</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;1&#34;</span>, <span class="s2">&#34;2&#34;</span><span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用guard进行提前返回">使用<code>guard</code>进行提前返回
</h4><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">guard</span> <span class="p">!</span><span class="n">a</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">guard</span> <span class="p">!</span><span class="n">b</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// do
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if a {
</span></span><span class="line"><span class="cl">    if b {
</span></span><span class="line"><span class="cl">        // do
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用三元运算符">使用三元运算符<code>?:</code>
</h4><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">let</span> <span class="nv">b</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nb">let</span> <span class="nv">a</span> <span class="o">=</span> b ? <span class="m">1</span> : <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">let</span> c: Int?
</span></span><span class="line"><span class="cl"><span class="nb">let</span> <span class="nv">b</span> <span class="o">=</span> c ?? <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">var</span> <span class="py">a</span><span class="p">:</span> <span class="n">Int</span><span class="p">?</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">b</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="p">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="p">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用for-where优化循环">使用<code>for where</code>优化循环
</h4><p><code>for</code>循环添加<code>where</code>语句，只有当<code>where</code>条件满足时才会进入循环</p>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">collection</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">hasProperty</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">for</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">hasProperty</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// item.hasProperty == true，才会进入循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用defer">使用<code>defer</code>
</h4><p><code>defer</code>可以保证在函数退出前一定会执行。可以使用<code>defer</code>中实现退出时一定会执行的操作例如<code>资源释放</code>等避免遗漏。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">func</span> <span class="n">method</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">lock</span><span class="p">.</span><span class="k">lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">defer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 会在method作用域结束的时候调用</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="字符串">字符串
</h3><h4 id="使用">使用<code>&quot;&quot;&quot;</code>
</h4><p>在定义<code>复杂</code>字符串时，使用<code>多行字符串字面量</code>可以保持原有字符串的换行符号/引号等特殊字符，不需要使用``进行转义。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">let</span> <span class="n">quotation</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">The White Rabbit put on his spectacles.  &#34;Where shall I begin,
</span></span></span><span class="line"><span class="cl"><span class="s2">please your Majesty?&#34; he asked.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;Begin at the beginning,&#34; the King said gravely, &#34;and go on
</span></span></span><span class="line"><span class="cl"><span class="s2">till you come to the end; then stop.&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>提示：上面字符串中的<code>&quot;&quot;</code>和换行可以自动保留。</p></blockquote>
<h4 id="使用字符串插值">使用字符串插值
</h4><p>使用字符串插值可以提高代码可读性。</p>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vbnet" data-lang="vbnet"><span class="line"><span class="cl"><span class="k">let</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="n">3</span>
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">multiplier</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;times 2.5 is&#34;</span> <span class="o">+</span> <span class="kt">String</span><span class="p">((</span><span class="kt">Double</span><span class="p">(</span><span class="n">multiplier</span><span class="p">)</span> <span class="o">*</span> <span class="n">2</span><span class="p">.</span><span class="n">5</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">let</span> <span class="nv">multiplier</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="nb">let</span> <span class="nv">message</span> <span class="o">=</span> <span class="s2">&#34;(multiplier) times 2.5 is (Double(multiplier) * 2.5)&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="集合">集合
</h3><h4 id="使用标准库提供的高阶函数">使用标准库提供的高阶函数
</h4><p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">nums</span> <span class="p">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">nums</span><span class="p">.</span><span class="n">count</span> <span class="p">==</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">nums</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kt">var</span> <span class="n">nums</span> <span class="p">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">nums</span><span class="p">.</span><span class="n">isEmpty</span>
</span></span><span class="line"><span class="cl"><span class="n">nums</span><span class="p">.</span><span class="n">first</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="访问控制">访问控制
</h3><p><code>Swift</code>中默认访问控制级别为<code>internal</code>。编码中应当尽可能减小<code>属性</code>/<code>方法</code>/<code>类型</code>的访问控制级别隐藏内部实现。</p>
<blockquote>
<p>提示：同时也有利于编译器进行优化。</p></blockquote>
<h4 id="使用privatefileprivate修饰私有属性和方法">使用<code>private</code>/<code>fileprivate</code>修饰私有<code>属性</code>和<code>方法</code>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">let</span> <span class="n">num</span> <span class="p">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">var</span> <span class="n">num</span><span class="p">:</span> <span class="n">Int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用privateset修饰外部只读内部可读写属性">使用<code>private(set)</code>修饰外部只读/内部可读写属性
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span><span class="p">(</span><span class="k">set</span><span class="p">)</span> <span class="kt">var</span> <span class="n">num</span> <span class="p">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="n">num</span> <span class="p">=</span> <span class="n">MyClass</span><span class="p">().</span><span class="n">num</span>
</span></span><span class="line"><span class="cl"><span class="n">MyClass</span><span class="p">().</span><span class="n">num</span> <span class="p">=</span> <span class="m">2</span> <span class="c1">// 会编译报错</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="函数">函数
</h3><h4 id="使用参数默认值">使用参数默认值
</h4><p>使用参数<code>默认值</code>，可以使调用方传递<code>更少</code>的参数。</p>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">test</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">String</span><span class="p">?,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">test</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">test</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">Int</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">test</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>提示：相比<code>ObjC</code>，<code>参数默认值</code>也可以让我们定义更少的方法。</p></blockquote>
<h4 id="限制参数数量">限制参数数量
</h4><p>当方法参数过多时考虑使用<code>自定义类型</code>代替。</p>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nc">Params</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">Int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Params</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用discardableresult">使用<code>@discardableResult</code>
</h4><p>某些方法使用方并不一定会处理返回值，可以考虑添加<code>@discardableResult</code>标识提示<code>Xcode</code>允许不处理返回值不进行<code>warning</code>提示。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-scss" data-lang="scss"><span class="line"><span class="cl"><span class="c1">// 上报方法使用方不关心是否成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nt">func</span> <span class="nt">report</span><span class="o">(</span><span class="nt">id</span><span class="nd">:</span> <span class="nt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nt">Bool</span> <span class="p">{}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@discardableResult</span> <span class="nt">func</span> <span class="nt">report2</span><span class="o">(</span><span class="nt">id</span><span class="nd">:</span> <span class="nt">String</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nt">Bool</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">report</span><span class="o">(</span><span class="s2">&#34;1&#34;</span><span class="o">)</span> <span class="o">//</span> <span class="nt">编译器会警告</span>
</span></span><span class="line"><span class="cl"><span class="nt">report2</span><span class="o">(</span><span class="s2">&#34;1&#34;</span><span class="o">)</span> <span class="o">//</span> <span class="nt">不处理返回值编译器不会警告</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="元组">元组
</h3><h4 id="避免过长的元组">避免过长的元组
</h4><p>元组虽然具有类型信息，但是并不包含<code>变量名</code>信息，使用方并不清晰知道变量的含义。所以当元组数量过多时考虑使用<code>自定义类型</code>代替。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">func</span> <span class="n">test</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">let</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">test</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">a</span><span class="err">，</span><span class="n">b</span><span class="err">，</span><span class="n">c类型一致</span><span class="err">，没有命名信息不清楚每个变量的含义</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="系统库">系统库
</h3><h4 id="kvonotification使用blockapi"><code>KVO</code>/<code>Notification</code> 使用 <code>block</code> API
</h4><p><code>block</code> API的优势：</p>
<ul>
<li><code>KVO</code> 可以支持 <code>KeyPath</code></li>
<li>不需要主动移除监听，<code>observer</code>释放时自动移除监听</li>
</ul>
<p>不推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Object</span><span class="p">:</span> <span class="n">NSObject</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">addObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKeyPath</span><span class="p">:</span> <span class="s">&#34;value&#34;</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="p">.</span><span class="n">new</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">NotificationCenter</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="k">#selector</span><span class="p">(</span><span class="n">test</span><span class="p">),</span> <span class="n">name</span><span class="p">:</span> <span class="n">NSNotification</span><span class="p">.</span><span class="n">Name</span><span class="p">(</span><span class="n">rawValue</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">),</span> <span class="n">object</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">override</span> <span class="kd">class</span> <span class="nc">func</span> <span class="n">observeValue</span><span class="p">(</span><span class="n">forKeyPath</span> <span class="n">keyPath</span><span class="p">:</span> <span class="nb">String</span><span class="p">?,</span> <span class="n">of</span> <span class="n">object</span><span class="p">:</span> <span class="nb">Any</span><span class="p">?,</span> <span class="n">change</span><span class="p">:</span> <span class="p">[</span><span class="n">NSKeyValueChangeKey</span> <span class="p">:</span> <span class="nb">Any</span><span class="p">]?,</span> <span class="n">context</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">?)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">@objc</span> <span class="kd">private</span> <span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">deinit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">removeObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKeyPath</span><span class="p">:</span> <span class="s">&#34;value&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">NotificationCenter</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">removeObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>推荐</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nb">Object</span><span class="o">:</span> <span class="nx">NSObject</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kd">var</span> <span class="nx">observer</span>: <span class="kt">AnyObserver?</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kd">var</span> <span class="nx">kvoObserver</span>: <span class="kt">NSKeyValueObservation?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">init() {</span>
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">.</span><span class="nx">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">observer</span> <span class="o">=</span> <span class="nx">NotificationCenter</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">addObserver</span><span class="p">(</span><span class="nx">forName</span>: <span class="kt">NSNotification.Name</span><span class="p">(</span><span class="nx">rawValue</span><span class="o">:</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="kt">object</span><span class="o">:</span> <span class="nx">nil</span><span class="p">,</span> <span class="nx">queue</span>: <span class="kt">nil</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="k">in</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kvoObserver</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">observe</span><span class="p">(.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="p">[.</span><span class="k">new</span><span class="p">])</span> <span class="p">{</span> <span class="p">(</span><span class="nx">foo</span><span class="p">,</span> <span class="nx">change</span><span class="p">)</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="protocol">Protocol
</h3><h4 id="使用protocol代替继承">使用<code>protocol</code>代替继承
</h4><p><code>Swift</code>中针对<code>protocol</code>提供了很多新特性，例如<code>默认实现</code>，<code>关联类型</code>，支持值类型。在代码设计时可以优先考虑使用<code>protocol</code>来避免臃肿的父类同时更多使用值类型。</p>
<blockquote>
<p>提示：一些无法用<code>protocol</code>替代<code>继承</code>的场景：1.需要继承NSObject子类。2.需要调用<code>super</code>方法。3.实现<code>抽象类</code>的能力。</p></blockquote>
<h3 id="extension">Extension
</h3><h4 id="使用extension组织代码">使用<code>extension</code>组织代码
</h4><p>使用<code>extension</code>将<code>私有方法</code>/<code>父类方法</code>/<code>协议方法</code>等不同功能代码进行分离更加清晰/易维护。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// class stuff here</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// </span><span class="cs">MARK:</span><span class="c1"> - Private</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span><span class="p">:</span> <span class="n">MyViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">method</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// </span><span class="cs">MARK:</span><span class="c1"> - UITableViewDataSource</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">MyViewController</span><span class="p">:</span> <span class="n">UITableViewDataSource</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// table view data source methods</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// </span><span class="cs">MARK:</span><span class="c1"> - UIScrollViewDelegate</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">MyViewController</span><span class="p">:</span> <span class="n">UIScrollViewDelegate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// scroll view delegate methods</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="代码风格">代码风格
</h3><p>良好的代码风格可以提高代码的<code>可读性</code>，统一的代码风格可以降低团队内相互<code>理解成本</code>。对于<code>Swift</code>的代码<code>格式化</code>建议使用自动格式化工具实现，将自动格式化添加到代码提交流程，通过定义Lint<code>规则</code>统一团队内代码风格。考虑使用<code>SwiftFormat</code>和<code>SwiftLint</code>。</p>
<blockquote>
<p>提示：<code>SwiftFormat</code>主要关注代码样式的格式化，<code>SwiftLint</code>可以使用<code>autocorrect</code>自动修复部分不规范的代码。</p></blockquote>
<p>常见的自动格式化修正</p>
<ul>
<li>移除多余的<code>;</code></li>
<li>最多只保留一行换行</li>
<li>自动对齐<code>空格</code></li>
<li>限制每行的宽度<code>自动换行</code></li>
</ul>
<h2 id="性能优化">性能优化
</h2><p>性能优化上主要关注提高<code>运行时性能</code>和降低<code>二进制体积</code>。需要考虑如何更好的使用<code>Swift</code>特性，同时提供更多信息给<code>编译器</code>进行优化。</p>
<h3 id="使用whole-module-optimization">使用<code>Whole Module Optimization</code>
</h3><p>当<code>Xcode</code>开启<code>WMO</code>优化时，编译器可以将整个程序编译为一个文件进行更多的优化。例如通过<code>推断final</code>/<code>函数内联</code>/<code>泛型特化</code>更多使用静态派发，并且可以<code>移除</code>部分未使用的代码。</p>
<h3 id="使用源代码打包">使用<code>源代码</code>打包
</h3><p>当我们使用<code>组件化</code>时，为了提高<code>编译速度</code>和<code>打包效率</code>，通常单个组件独立编译生成<code>静态库</code>，最后多个组件直接使用<code>静态库</code>进行打包。这种场景下<code>WMO</code>仅针对<code>internal</code>以内作用域生效，对于<code>public/open</code>缺少外部使用信息所以无法进行优化。所以对于大量使用<code>Swift</code>的项目，使用<code>全量代码打包</code>更有利于编译器做更多优化。</p>
<h3 id="减少方法动态派发">减少方法<code>动态</code>派发
</h3><ul>
<li><code>使用final</code> - <code>class</code>/<code>方法</code>/<code>属性</code>申明为<code>final</code>，编译器可以优化为静态派发</li>
<li><code>使用private</code> - <code>方法</code>/<code>属性</code>申明为<code>private</code>，编译器可以优化为静态派发</li>
<li><code>避免使用dynamic</code> - <code>dynamic</code>会使方法通过ObjC<code>消息转发</code>的方式派发</li>
<li><code>使用WMO</code> - 编译器可以自动分析推断出<code>final</code>优化为静态派发</li>
</ul>
<h3 id="使用slice共享内存优化性能">使用<code>Slice</code>共享内存优化性能
</h3><p>在使用<code>Array</code>/<code>String</code>时，可以使用<code>Slice</code>切片获取一部分数据。<code>Slice</code>保存对原始<code>Array</code>/<code>String</code>的引用共享内存数据，不需要重新分配空间进行存储。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-erlang" data-lang="erlang"><span class="line"><span class="cl"><span class="k">let</span> <span class="n">midpoint</span> <span class="o">=</span> <span class="n">absences</span><span class="p">.</span><span class="n">count</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="n">firstHalf</span> <span class="o">=</span> <span class="n">absences</span><span class="p">[..</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>`提示：应避免一直持有Slice，Slice会延长原始Array/String的生命周期导致无法被释放造成内存泄漏。</p>
<p>protocol添加AnyObject protocol AnyProtocol {}</p>
<p>protocol ObjectProtocol: AnyObject {}</p>
<p>当protocol仅限制为class使用时，继承AnyObject协议可以使编译器不需要考虑值类型实现，提高运行时性能。</p>
<p>使用@inlinable进行方法内联优化 // 原始代码 let label = UILabel().then {     0.textAlignment=.center0.textColor = UIColor.black     $0.text = &ldquo;Hello, World!&rdquo; }</p>
<p>以then库为例，他使用闭包进行对象初始化以后的相关设置。但是 then 方法以及闭包也会带来额外的性能消耗。</p>
<p>内联优化 @inlinable public func then(_ block: (Self) throws -&gt; Void) rethrows -&gt; Self { try block(self) return self }</p>
<p>// 编译器内联优化后 let label = UILabel() label.textAlignment = .center label.textColor = UIColor.black label.text = &ldquo;Hello, World!&rdquo;</p>
<p>属性 使用lazy延时初始化属性 class View { var lazy label: UILabel = { let label = UILabel() self.addSubView(label) return label }() }</p>
<p>lazy属性初始化会延迟到第一次使用时，常见的使用场景：</p>
<p>初始化比较耗时</p>
<p>可能不会被使用到</p>
<p>初始化过程需要使用self</p>
<p>提示：lazy属性不能保证线程安全</p>
<p>避免使用private let属性</p>
<p>private let属性会增加每个class对象的内存大小。同时会增加包大小，因为需要为属性生成相关的信息。可以考虑使用文件级private let申明或static常量代替。</p>
<p>不推荐 class Object { private let title = &ldquo;12345&rdquo; }</p>
<p>推荐 private let title = &ldquo;12345&rdquo; class Object { static let title = &quot;&quot; }</p>
<p>提示：这里并不包括通过init初始化注入的属性。</p>
<p>使用didSet/willSet时进行Diff</p>
<p>某些场景需要使用didSet/willSet属性检查器监控属性变化，做一些额外的计算。但是由于didSet/willSet并不会检查新/旧值是否相同，可以考虑添加新/旧值判断，只有当值真的改变时才进行运算提高性能。</p>
<p>优化前 class Object { var orderId: String? { didSet { // 拉取接口等操作 } } }</p>
<p>例如上面的例子，当每一次orderId变更时需要重新拉取当前订单的数据，但是当orderId值一样时，拉取订单数据是无效执行。</p>
<p>优化后 class Object { var orderId: String? { didSet { // 判断新旧值是否相等 guard oldValue != orderId else { return } // 拉取接口等操作 } } }</p>
<p>集合 集合使用lazy延迟序列 var nums = [1, 2, 3] var result = nums.lazy.map { String($0) } result[0] // 对1进行map操作 result[1] // 对2进行map操作</p>
<p>在集合操作时使用lazy，可以将数组运算操作推迟到第一次使用时，避免一次性全部计算。</p>
<p>提示：例如长列表，我们需要创建每个cell对应的视图模型，一次性创建太耗费时间。</p>
<p>使用合适的集合方法优化性能 不推荐 var items = [1, 2, 3] items.filter({ $0 &gt; 1 }).first // 查找出所有大于1的元素，之后找出第一个</p>
<p>推荐 var items = [1, 2, 3] items.first(where: { $0 &gt; 1 }) // 查找出第一个大于1的元素直接返回</p>
<p>使用值类型</p>
<p>Swift中的值类型主要是结构体/枚举/元组。</p>
<p>启动性能 - APP启动时值类型没有额外的消耗，class有一定额外的消耗。</p>
<p>运行时性能- 值类型不需要在堆上分配空间/额外的引用计数管理。更少的内存占用和更快的性能。</p>
<p>包大小 - 相比class，值类型不需要创建ObjC类对应的ro_data_t数据结构。</p>
<p>提示：class即使没有继承NSObject也会生成ro_data_t，里面包含了ivars属性信息。如果属性/方法申明为@objc还会生成对应的方法列表。</p>
<p>提示：struct无法代替class的一些场景：1.需要使用继承调用super。2.需要使用引用类型。3.需要使用deinit。4.需要在运行时动态转换一个实例的类型。</p>
<p>提示：不是所有struct都会保存在栈上，部分数据大的struct也会保存在堆上。</p>
<p>集合元素使用值类型</p>
<p>集合元素使用值类型。因为NSArray并不支持值类型，编译器不需要处理可能需要桥接到NSArray的场景，可以移除部分消耗。</p>
<p>纯静态类型避免使用class</p>
<p>当class只包含静态方法/属性时，考虑使用enum代替class，因为class会生成更多的二进制代码。</p>
<p>不推荐 class Object { static var num: Int static func test() {} }</p>
<p>推荐 enum Object { static var num: Int static func test() {} }</p>
<p>提示：为什么用enum而不是struct，因为struct会额外生成init方法。</p>
<p>值类型性能优化 考虑使用引用类型</p>
<p>值类型为了维持值语义，会在每次赋值/参数传递/修改时进行复制。虽然编译器本身会做一些优化，例如写时复制优化，在修改时减少复制频率，但是这仅针对于标准库提供的集合和String结构有效，对于自定义结构需要自己实现。对于参数传递编译器在一些场景会优化为直接传递引用的方式避免复制行为。</p>
<p>但是对于一些数据特别大的结构，同时需要频繁变更修改时也可以考虑使用引用类型实现。</p>
<p>使用inout传递参数减少复制</p>
<p>虽然编译器本身会进行写时复制的优化，但是部分场景编译器无法处理。</p>
<p>不推荐 func append_one(_ a: [Int]) -&gt; [Int] { var a = a a.append(1) // 无法被编译器优化，因为这时候有2个引用持有数组 return a }</p>
<p>var a = [1, 2, 3] a = append_one(a)</p>
<p>推荐</p>
<p>直接使用inout传递参数</p>
<p>func append_one_in_place(a: inout [Int]) { a.append(1) }</p>
<p>var a = [1, 2, 3] append_one_in_place(&amp;a)</p>
<p>使用isKnownUniquelyReferenced实现写时复制</p>
<p>默认情况下结构体中包含引用类型，在修改时只会重新拷贝引用。但是我们希望CustomData具备值类型的特性，所以当修改时需要重新复制NSMutableData避免复用。但是复制操作本身是耗时操作，我们希望可以减少一些不必要的复制。</p>
<p>优化前 struct CustomData { fileprivate var _data: NSMutableData var _dataForWriting: NSMutableData { mutating get { _data = _data.mutableCopy() as! NSMutableData return <em>data } } init(</em> data: NSData) { self._data = data.mutableCopy() as! NSMutableData }</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kr">mutating</span> <span class="kd">func</span> <span class="nf">append</span><span class="p">(</span><span class="kc">_</span> <span class="n">other</span><span class="p">:</span> <span class="n">MyData</span><span class="p">)</span> <span class="p">{</span>         <span class="n">_dataForWriting</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">_data</span> <span class="k">as</span> <span class="n">Data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>}</p>
<p>var buffer = CustomData(NSData()) for _ in 0..&lt;5 { buffer.append(x) // 每一次调用都会复制 }</p>
<p>优化后</p>
<p>使用isKnownUniquelyReferenced检查如果是唯一引用不进行复制。</p>
<p>final class Box { var unbox: A init(_ value: A) { self.unbox = value } }</p>
<p>struct CustomData { fileprivate var _data: Box var _dataForWriting: NSMutableData { mutating get { // 检查引用是否唯一 if !isKnownUniquelyReferenced(&amp;_data) { _data = Box(_data.unbox.mutableCopy() as! NSMutableData) } return <em>data.unbox } } init(</em> data: NSData) { self._data = Box(data.mutableCopy() as! NSMutableData) } }</p>
<p>var buffer = CustomData(NSData()) for _ in 0..&lt;5 { buffer.append(x) // 只会在第一次调用时进行复制 }</p>
<p>提示：对于ObjC类型isKnownUniquelyReferenced会直接返回false。</p>
<p>减少使用Objc特性 避免使用Objc类型</p>
<p>尽可能避免在Swift中使用NSString/NSArray/NSDictionary等ObjC基础类型。以Dictionary为例，虽然Swift Runtime可以在NSArray和Array之间进行隐式桥接需要O(1)的时间。但是字典当Key和Value既不是类也不是@objc协议时，需要对每个值进行桥接，可能会导致消耗O(n)时间。</p>
<p>减少添加@objc标识</p>
<p>@objc标识虽然不会强制使用消息转发的方式来调用方法/属性，但是他会默认ObjC是可见的会生成和ObjC一样的ro_data_t结构。</p>
<p>避免使用@objcMembers</p>
<p>使用@objcMembers修饰的类，默认会为类/属性/方法/扩展都加上@objc标识。</p>
<p>@objcMembers class Object: NSObject { }</p>
<p>提示：你也可以使用@nonobjc取消支持ObjC。</p>
<p>避免继承NSObject</p>
<p>你只需要在需要使用NSObject特性时才需要继承，例如需要实现UITableViewDataSource相关协议。</p>
<p>使用let变量/属性 优化集合创建</p>
<p>集合不需要修改时，使用let修饰，编译器会优化创建集合的性能。例如针对let集合，编译器在创建时可以分配更小的内存大小。</p>
<p>优化逃逸闭包</p>
<p>在Swift中，当捕获var变量时编译器需要生成一个在堆上的Box保存变量用于之后对于变量的读/写，同时需要额外的内存管理操作。如果是let变量，编译器可以保存值复制或引用，避免使用Box。</p>
<p>避免使用大型struct使用class代替</p>
<p>大型struct通常是指属性特别多并且嵌套类型很多。目前swift编译器针对struct等值类型编译优化处理的并不好，会生成大量的assignWithCopy、assignWithCopy等copy相关方法，生成大量的二进制代码。使用class类型可以避免生成相关的copy方法。</p>
<p>提示：不要小看这部分二进制的影响，个人在日常项目中遇到过复杂的大型struct能生成几百KB的二进制代码。但是目前并没有好的方法去发现这类struct去做优化，只能通过相关工具去查看生成的二进制详细信息。希望官方可以早点优化。</p>
<p>优先使用Encodable/Decodable协议代替Codable</p>
<p>因为实现Encodable和Decodable协议的结构，编译器在编译时会自动生成对应的init(from decoder: Decoder)和encode(to: Encoder)方法。Codable同时实现了Encodable和Decodable协议，但是大部分场景下我们只需要encode或decode能力，所以明确指定实现Encodable或Decodable协议可以减少生成对应的方法减少包体积。</p>
<p>提示：对于属性比较多的类型结构会产生很大的二进制代码，有兴趣可以用相关的工具看看生成的二进制文件。</p>
<p>减少使用Equatable协议</p>
<p>因为实现Equatable协议的结构，编译器在编译时会自动生成对应的equal方法。默认实现是针对所有字段进行比较会生成大量的代码。所以当我们不需要实现==比较能力时不要实现Equatable或者对于属性特别多的类型也可以考虑重写Equatable协议，只针对部分属性进行比较，这样可以生成更少的代码减少包体积。</p>
<p>提示：对于属性特别多的类型也可以考虑重写Equatable协议，只针对部分属性进行比较，同时也可以提升性能。</p>
<h1 id="总结">总结
</h1><p>个人从Swift3.0开始将Swift作为第一语言使用。编写Swift代码并不只是简单对于ObjC代码的翻译/重写，需要对于Swift特性更多的理解才能更好的利用这些特性带来更多的收益。同时我们需要关注每个版本Swift的优化/改进和新特性。在这过程中也会提高我们的编码能力，加深对于一些通用编程概念/思想的理解，包括空安全、值类型、协程、不共享数据的Actor并发模型、函数式编程、面向协议编程、内存所有权等。对于新的现代编程语言例如Swift/Dart/TS/Kotlin/Rust等，很多特性/思想都是相互借鉴，当我们理解这些概念/思想以后对于理解其他语言也会更容易。</p>
<p>这里推荐有兴趣可以关注Swift Evolution，每个特性加入都会有一个提案，里面会详细介绍动机/使用场景/实现方式/未来方向。</p>
<h1 id="扩展链接">扩展链接
</h1><p>The Swift Programming Language</p>
<p>Swift 进阶</p>
<p>SwiftLint Rules</p>
<p>OptimizationTips</p>
<p>深入剖析Swift性能优化</p>
<p>Google Swift Style Guide</p>
<p>Swift Evolution</p>
<p>Dictionary</p>
<p>Array</p>
<p>String</p>
<p>struct`</p>
<p>标签: <a class="link" href="https://www.cnblogs.com/Jcloud/tag/Swift/"  target="_blank" rel="noopener"
    >Swift</a> , <a class="link" href="https://www.cnblogs.com/Jcloud/tag/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F/"  target="_blank" rel="noopener"
    >代码质量</a></p>
<p><a class="link" href="#" >好文要顶</a> <a class="link" href="#" >关注我</a> <a class="link" href="#" >收藏该文</a> <a class="link" href="#" >微信分享</a></p>
<p><a class="link" href="https://home.cnblogs.com/u/Jcloud/"  target="_blank" rel="noopener"
    >

















<img 
    src="https://pic.cnblogs.com/face/2927063/20230609145847.png" 
    alt="" 
     
/></a></p>
<p><a class="link" href="https://home.cnblogs.com/u/Jcloud/"  target="_blank" rel="noopener"
    >京东云开发者</a><br>
<a class="link" href="https://home.cnblogs.com/u/Jcloud/followers/"  target="_blank" rel="noopener"
    >粉丝 - 375</a> <a class="link" href="https://home.cnblogs.com/u/Jcloud/followees/"  target="_blank" rel="noopener"
    >关注 - 1</a></p>
<p><a class="link" href="#" >+加关注</a></p>
<p>0</p>
<p>0</p>
<p><a class="link" href="https://cnblogs.vip/"  target="_blank" rel="noopener"
    >升级成为会员</a></p>
<p>currentDiggType = 0;</p>
<p><a class="link" href="https://www.cnblogs.com/Jcloud/p/17387140.html"  target="_blank" rel="noopener"
    >«</a> 上一篇： <a class="link" href="https://www.cnblogs.com/Jcloud/p/17387140.html"  title="发布于 2023-05-10 10:01"
     target="_blank" rel="noopener"
    >从原理到应用，人人都懂的ChatGPT指南</a><br>
<a class="link" href="https://www.cnblogs.com/Jcloud/p/17390152.html"  target="_blank" rel="noopener"
    >»</a> 下一篇： <a class="link" href="https://www.cnblogs.com/Jcloud/p/17390152.html"  title="发布于 2023-05-11 09:52"
     target="_blank" rel="noopener"
    >Webpack5构建性能优化：构建耗时从150s到60s再到10s</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 Example Person
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.868431583616a0f387d4d1885f6025629dd2ee41c4b84fa7e740b51ff3e10b3f.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
